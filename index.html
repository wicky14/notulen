<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=5.0">
    <title>Notulen AGV</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* --- CSS PREVIEW PDF (Ukuran A4 Presisi) --- */
        @import url('https://fonts.googleapis.com/css2?family=Arimo:wght@400;700&display=swap');

        /* Lebar standar A4 di 96 DPI (794px) */
        .a4-page {
            width: 794px; 
            min-height: 1123px; 
            padding: 10mm 15mm;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 15px rgba(0,0,0,0.15);
            font-family: 'Arimo', Arial, sans-serif;
            font-size: 10pt;
            color: black;
            position: relative;
            box-sizing: border-box;
            page-break-after: always;
        }
        
        #pdf-content {
            transform-origin: top center; 
            transition: transform 0.2s ease-out; 
        }
        
        .doc-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .doc-table th, .doc-table td {
            border: 1px solid black;
            padding: 4px 6px;
            vertical-align: top;
        }
        .doc-table th {
            background-color: #f3f4f6;
            text-align: center;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 9pt;
        }

        .doc-table td ul, .doc-table td ol {
            padding-left: 20px;
            margin-top: 0px;
            margin-bottom: 0px;
        }
        .doc-table td ul {
            list-style-type: disc;
        }
        .doc-table td ol {
            list-style-type: decimal;
        }
        .doc-table td span[style*="background-color: #fff3c4"] {
             background-color: #fff3c4; 
        }

        .header-container {
            display: grid;
            grid-template-columns: 20% 55% 25%;
            border-bottom: 2px solid black;
            padding-bottom: 8px;
            margin-bottom: 12px;
            align-items: center;
        }
        .header-logo-container {
            text-align: left;
            padding-right: 5px; 
        }
        .header-logo-container img {
            max-height: 70px;
            width: auto;
            display: block;
        }
        .header-center {
            text-align: center;
        }
        .header-center h1 { font-size: 11pt; font-weight: bold; margin: 0; }
        .header-center h2 { font-size: 11pt; font-weight: bold; margin: 0; }
        .header-center h3 { font-size: 11pt; font-weight: bold; margin-top: 4px; }
        .header-meta table {
            width: 100%;
            font-size: 8pt;
            border-collapse: collapse;
        }
        .header-meta td {
            border: none;
            padding: 1px 2px;
        }
        .header-meta tr td:first-child { 
            font-weight: bold; 
            width: 60px; 
            white-space: nowrap; 
        }
        .info-section {
            display: table;
            width: 100%;
            margin-bottom: 10px;
        }
        .info-row { display: table-row; }
        .info-label { display: table-cell; width: 100px; font-weight: normal; padding: 2px 0; }
        .info-sep { display: table-cell; width: 10px; padding: 2px 0; }
        .info-val { display: table-cell; font-weight: normal; padding: 2px 0; }
        .footer-sign {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding: 0 30px;
            page-break-inside: avoid;
        }
        .sign-box {
            text-align: center;
            width: 200px;
        }
        .sign-gap { height: 60px; }
        .sign-name { font-weight: bold; text-decoration: underline; }
        [x-cloak] { display: none !important; }

        @media (min-width: 1024px) { 
            .layout-container { display: flex; height: 100%; }
            .sidebar-input { width: var(--sidebar-width, 380px); flex-shrink: 0; overflow-y: auto; }
            .content-preview { flex-grow: 1; overflow-y: auto; padding: 1rem; }
            .bottom-bar { display: none !important; }
            .resizer { width: 8px; cursor: ew-resize; background-color: #4b5563; flex-shrink: 0; z-index: 30; }
        }

        @media (max-width: 1023px) { 
            .layout-container { flex-direction: column; height: 100%; overflow: hidden; }
            .sidebar-input, .content-preview { width: 100%; max-height: calc(100vh - 56px); overflow-y: auto; }
            .sidebar-input.hidden-mobile, .content-preview.hidden-mobile { display: none; }
            .bottom-bar { position: fixed; bottom: 0; left: 0; width: 100%; z-index: 50; height: 56px; }
            .a4-page { box-shadow: none; }
            #pdf-content { margin: 0 !important; }
            /* Penyesuaian agar preview berada di tengah saat dizoom */
            #pdf-content { margin-left: auto !important; margin-right: auto !important; }
            .content-preview { padding: 8px !important; }
        }
        
        @media print {
            .sidebar-input, .bottom-bar, .resizer, .zoom-controls { display: none !important; }
            .layout-container, .content-preview { width: 100%; max-width: none; margin: 0; padding: 0; box-shadow: none; overflow: visible !important; }
            #pdf-content { transform: none !important; margin: 0 !important; }
            .a4-page { width: 210mm !important; box-shadow: none !important; margin: 0 !important; padding: 10mm 15mm !important; min-height: auto !important; page-break-after: always; }
            body { overflow: visible !important; background: white !important; }
            .a4-page .doc-table td span[style*="background-color"] { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .a4-page img { max-width: 100% !important; display: block !important; }
            .a4-page .aspect-square img { height: 100% !important; object-fit: cover !important; }
            @page { size: A4; margin: 0; }
        }
    </style>
</head>

<body class="bg-gray-100 h-screen overflow-hidden text-gray-800" x-data="appData()" x-init="initData()" x-on:resize.window="handleResize()">

    <div class="layout-container h-full">
        
        <div class="sidebar-input bg-white h-full flex flex-col shadow-xl z-20 border-r border-gray-200"
             x-ref="sidebar"
             :class="{ 'hidden-mobile': activeTab !== 'input' && window.innerWidth < 1024 }">
            
            <div class="p-4 bg-gray-900 text-white shadow-md flex justify-between items-center shrink-0">
                <h1 class="font-bold text-lg tracking-wide">Notulen AGV</h1>
                <div class="flex space-x-2">
                    <label for="importFile" class="bg-yellow-600 hover:bg-yellow-500 text-white p-2 rounded shadow transition cursor-pointer" title="Import Data">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                        <input type="file" id="importFile" @change="importData" class="hidden" accept=".json">
                    </label>

                    <button @click="exportData" class="bg-blue-600 hover:bg-blue-500 text-white p-2 rounded shadow transition" title="Export Draft">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>
                    </button>
                    
                    <button @click="generatePDF" class="bg-red-600 hover:bg-red-500 text-white p-2 rounded shadow transition" title="Print to PDF">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2z" /></svg>
                    </button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto pt-4 px-4 pb-24 space-y-6 bg-gray-50">
                <div class="bg-white p-3 rounded shadow-sm border border-gray-200">
                    <h3 class="font-bold text-gray-700 text-sm mb-3 border-b pb-1">Info Dokumen</h3>
                    <div class="grid grid-cols-1 gap-2">
                        <div><label class="text-xs text-gray-500">No. Dokumen</label><input x-model="doc.no" class="w-full border p-1 rounded text-sm"></div>
                        <div><label class="text-xs text-gray-500">Tgl Berlaku</label><input x-model="doc.tgl" class="w-full border p-1 rounded text-sm"></div>
                        <div><label class="text-xs text-gray-500">Revisi</label><input x-model="doc.rev" class="w-full border p-1 rounded text-sm"></div>
                    </div>
                </div>

                <div class="bg-white p-3 rounded shadow-sm border border-gray-200">
                    <h3 class="font-bold text-gray-700 text-sm mb-3 border-b pb-1">Detail Rapat</h3>
                    <div class="space-y-2">
                        <div><label class="text-xs text-gray-500">Tanggal</label><input type="date" x-model="meet.date" class="w-full border p-1 rounded text-sm"></div>
                        <div><label class="text-xs text-gray-500">Waktu</label><input x-model="meet.time" class="w-full border p-1 rounded text-sm" placeholder="Contoh: 20.00-22.00"></div>
                        <div><label class="text-xs text-gray-500">Tempat</label><input x-model="meet.place" class="w-full border p-1 rounded text-sm"></div>
                        <div><label class="text-xs text-gray-500">Agenda</label><input x-model="meet.agenda" class="w-full border p-1 rounded text-sm"></div>
                    </div>
                </div>

                <div class="bg-white p-3 rounded shadow-sm border border-gray-200">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-gray-700 text-sm">Pembahasan</h3>
                        <button @click="addItem" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded hover:bg-green-200 font-bold">+ Item</button>
                    </div>
                    <div class="space-y-3">
                        <template x-for="(item, index) in items" :key="index">
                            <div class="border p-2 rounded bg-gray-50 relative">
                                <button @click="removeItem(index)" class="absolute top-1 right-1 text-red-400 hover:text-red-600 text-lg leading-none">&times;</button>
                                <input x-model="item.topic" placeholder="Judul Pembahasan" class="w-full border-b bg-transparent p-1 text-sm font-bold mb-1 focus:outline-none">
                                <textarea 
                                    x-model="item.detail" 
                                    x-init="autoExpand($el); $watch('item.detail', () => autoExpand($el))" 
                                    @input="autoExpand($el)"
                                    placeholder="Detail Tindak Lanjut..." 
                                    class="w-full border p-1 text-sm rounded mb-1 overflow-hidden"
                                    style="min-height: 4rem; height: 4rem;" 
                                    @contextmenu.prevent="showCustomContextMenu($event)"
                                    @touchstart="startLongPress($event)" 
                                    @touchend="cancelLongPress()"
                                    @touchmove="cancelLongPress()"
                                    x-on:keydown="handleKeydown($event, index)"
                                ></textarea>
                                <div class="flex gap-2">
                                    <input x-model="item.pic" placeholder="PIC" class="w-1/2 border p-1 text-xs rounded">
                                    <input type="date" x-model="item.due" placeholder="Due Date" class="w-1/2 border p-1 text-xs rounded">
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <div class="bg-white p-3 rounded shadow-sm border border-gray-200">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-gray-700 text-sm">Daftar Hadir</h3>
                        <button @click="addAttendee" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 font-bold">+ Peserta</button>
                    </div>
                    <div class="space-y-1">
                        <template x-for="(p, i) in attendees" :key="i">
                            <div class="flex gap-1 items-center">
                                <span x-text="i+1+'.'" class="text-xs w-4 text-gray-400"></span>
                                <input x-model="p.name" placeholder="Nama" class="w-1/2 border p-1 text-xs rounded">
                                <input x-model="p.address" placeholder="Blok/No" class="w-1/3 border p-1 text-xs rounded">
                                <button @click="removeAttendee(i)" class="text-red-400 hover:bg-red-50 rounded px-1">&times;</button>
                            </div>
                        </template>
                    </div>
                </div>

                <div class="bg-white p-3 rounded shadow-sm border border-gray-200">
                    <h3 class="font-bold text-gray-700 text-sm mb-2">Dokumentasi</h3>
                    <input type="file" multiple @change="handlePhotos" class="text-xs w-full mb-2" accept="image/*">
                    <div class="grid grid-cols-3 gap-2">
                        <template x-for="(photo, idx) in photos" :key="idx">
                            <div class="relative group aspect-square">
                                <img :src="photo" class="w-full h-full object-cover rounded border">
                                <button @click="removePhoto(idx)" class="absolute top-0 right-0 bg-red-600 text-white w-5 h-5 flex items-center justify-center text-xs opacity-100 rounded-bl">&times;</button>
                            </div>
                        </template>
                    </div>
                </div>

                <div class="bg-white p-3 rounded shadow-sm border border-gray-200 pb-8">
                    <h3 class="font-bold text-gray-700 text-sm mb-3 border-b pb-1">Penandatangan</h3>
                    <div class="space-y-3">
                        <div><label class="text-xs font-bold text-gray-500">Ketua Paguyuban</label><input x-model="signer.ketua" class="w-full border p-1 rounded text-sm"></div>
                        <div>
                            <label class="text-xs font-bold text-gray-500">Notulis</label>
                            <input x-model="signer.notulis_nama" class="w-full border p-1 rounded text-sm mb-1" placeholder="Nama">
                            <input x-model="signer.notulis_jabatan" class="w-full border p-1 rounded text-sm" placeholder="Jabatan">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="resizer hidden lg:block" x-on:mousedown="startResize($event)" x-ref="resizer"></div>

        <div class="content-preview bg-gray-700 flex justify-center relative"
             x-ref="previewContainer"
             :class="{ 'hidden-mobile': activeTab !== 'preview' && window.innerWidth < 1024 }">
            
            <button @click="popOutPreview" 
                    class="hidden lg:flex fixed bottom-8 right-8 bg-purple-600 hover:bg-purple-500 text-white p-4 rounded-full shadow-2xl transition-all hover:scale-110 z-50 items-center justify-center" 
                    title="Pop-out Preview">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
            </button>

            <div id="pdf-content" :style="`transform: scale(${zoomLevel});`" class="py-4">
                <div class="a4-page">
                    <div class="header-container">
                        <div class="header-logo-container"><img src="https://raw.githubusercontent.com/wicky14/notulen/main/AGV%20Logo.png"></div>
                        <div class="header-center">
                            <h1>PAGUYUBAN AHSANA GREEN VILLAGE</h1>
                            <h2>KEPENGURUSAN 2024-2026</h2>
                            <h3>NOTULEN RAPAT</h3>
                        </div>
                        <div class="header-meta">
                            <table>
                                <tr><td>No. Dok</td><td>: <span x-text="doc.no"></span></td></tr>
                                <tr><td>Tgl. Berlaku</td><td>: <span x-text="doc.tgl"></span></td></tr>
                                <tr><td>No. Revisi</td><td>: <span x-text="doc.rev"></span></td></tr>
                                <tr><td>Halaman</td><td>: 1</td></tr>
                            </table>
                        </div>
                    </div>
                    <div class="info-section">
                        <div class="info-row"><div class="info-label">Tanggal</div><div class="info-sep">:</div><div class="info-val" x-text="formatDate(meet.date)"></div></div>
                        <div class="info-row"><div class="info-label">Waktu</div><div class="info-sep">:</div><div class="info-val" x-text="meet.time"></div></div>
                        <div class="info-row"><div class="info-label">Tempat</div><div class="info-sep">:</div><div class="info-val" x-text="meet.place"></div></div>
                        <div class="info-row"><div class="info-label">Agenda</div><div class="info-sep">:</div><div class="info-val" x-text="meet.agenda"></div></div>
                    </div>
                    <table class="doc-table">
                        <thead>
                            <tr>
                                <th style="width: 5%">NO.</th>
                                <th style="width: 25%">ITEM PEMBAHASAN</th>
                                <th style="width: 40%">TINDAK LANJUT</th>
                                <th style="width: 15%">PIC</th>
                                <th style="width: 15%">DUE DATE</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="(item, i) in items" :key="i">
                                <tr>
                                    <td class="text-center" x-text="i + 1"></td>
                                    <td class="font-bold" x-text="item.topic"></td>
                                    <td x-html="renderMarkdown(item.detail)"></td>
                                    <td class="text-center" x-text="item.pic"></td>
                                    <td class="text-center" x-text="formatDate(item.due)"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div class="footer-sign">
                        <div class="sign-box">
                            <p>Disetujui oleh:</p>
                            <div class="sign-gap"></div>
                            <p class="sign-name" x-text="signer.ketua"></p>
                            <p>Ketua Paguyuban AGV 2024-2026</p>
                        </div>
                        <div class="sign-box">
                            <p>Dibuat oleh:</p>
                            <div class="sign-gap"></div>
                            <p class="sign-name" x-text="signer.notulis_nama"></p>
                            <p x-text="signer.notulis_jabatan"></p>
                            <p>Notulis</p>
                        </div>
                    </div>
                </div>

                <div class="a4-page">
                    <div class="header-container">
                        <div class="header-logo-container"><img src="https://raw.githubusercontent.com/wicky14/notulen/main/AGV%20Logo.png"></div>
                        <div class="header-center">
                            <h1>PAGUYUBAN AHSANA GREEN VILLAGE</h1>
                            <h2>KEPENGURUSAN 2024-2026</h2>
                            <h3>DAFTAR HADIR</h3>
                        </div>
                        <div class="header-meta">
                            <table>
                                <tr><td>No. Dok</td><td>: <span x-text="doc.no"></span></td></tr>
                                <tr><td>Tgl. Berlaku</td><td>: <span x-text="doc.tgl"></span></td></tr>
                                <tr><td>No. Revisi</td><td>: <span x-text="doc.rev"></span></td></tr>
                                <tr><td>Halaman</td><td>: 2</td></tr>
                            </table>
                        </div>
                    </div>
                    <div class="info-section">
                        <div class="info-row"><div class="info-label">Tanggal</div><div class="info-sep">:</div><div class="info-val" x-text="formatDate(meet.date)"></div></div>
                        <div class="info-row"><div class="info-label">Waktu</div><div class="info-sep">:</div><div class="info-val" x-text="meet.time"></div></div>
                        <div class="info-row"><div class="info-label">Tempat</div><div class="info-sep">:</div><div class="info-val" x-text="meet.place"></div></div>
                        <div class="info-row"><div class="info-label">Agenda</div><div class="info-sep">:</div><div class="info-val" x-text="meet.agenda"></div></div>
                    </div>
                    <table class="doc-table">
                        <thead>
                            <tr>
                                <th style="width: 10%">NO</th>
                                <th style="width: 40%">NAMA</th>
                                <th style="width: 30%">ADDRESS</th>
                                <th style="width: 20%">KEHADIRAN</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="(p, i) in attendees" :key="i">
                                <tr>
                                    <td class="text-center" x-text="i + 1"></td>
                                    <td x-text="p.name"></td>
                                    <td class="text-center" x-text="p.address"></td>
                                    <td class="text-center">Hadir</td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div class="footer-sign">
                        <div class="sign-box">
                            <p>Disetujui oleh:</p>
                            <div class="sign-gap"></div>
                            <p class="sign-name" x-text="signer.ketua"></p>
                            <p>Ketua Paguyuban AGV 2024-2026</p>
                        </div>
                        <div class="sign-box">
                            <p>Dibuat oleh:</p>
                            <div class="sign-gap"></div>
                            <p class="sign-name" x-text="signer.notulis_nama"></p>
                            <p x-text="signer.notulis_jabatan"></p>
                            <p>Notulis</p>
                        </div>
                    </div>
                </div>

                <div class="a4-page">
                    <div class="header-container">
                        <div class="header-logo-container"><img src="https://raw.githubusercontent.com/wicky14/notulen/main/AGV%20Logo.png"></div>
                        <div class="header-center">
                            <h1>PAGUYUBAN AHSANA GREEN VILLAGE</h1>
                            <h2>KEPENGURUSAN 2024-2026</h2>
                            <h3>DOKUMENTASI</h3>
                        </div>
                        <div class="header-meta">
                            <table>
                                <tr><td>No. Dok</td><td>: <span x-text="doc.no"></span></td></tr>
                                <tr><td>Tgl. Berlaku</td><td>: <span x-text="doc.tgl"></span></td></tr>
                                <tr><td>No. Revisi</td><td>: <span x-text="doc.rev"></span></td></tr>
                                <tr><td>Halaman</td><td>: 3</td></tr>
                            </table>
                        </div>
                    </div>
                    <div class="info-section">
                        <div class="info-row"><div class="info-label">Tanggal</div><div class="info-sep">:</div><div class="info-val" x-text="formatDate(meet.date)"></div></div>
                        <div class="info-row"><div class="info-label">Waktu</div><div class="info-sep">:</div><div class="info-val" x-text="meet.time"></div></div>
                        <div class="info-row"><div class="info-label">Tempat</div><div class="info-sep">:</div><div class="info-val" x-text="meet.place"></div></div>
                        <div class="info-row"><div class="info-label">Agenda</div><div class="info-sep">:</div><div class="info-val" x-text="meet.agenda"></div></div>
                    </div>
                    <div class="mt-6 grid grid-cols-3 gap-3">
                        <template x-for="photo in photos">
                            <div class="border p-1 bg-white shadow-sm aspect-square flex justify-center items-center overflow-hidden">
                                <img :src="photo" class="w-full h-full object-cover">
                            </div>
                        </template>
                    </div>
                    <div class="footer-sign mt-10">
                        <div class="sign-box">
                            <p>Disetujui oleh:</p>
                            <div class="sign-gap"></div>
                            <p class="sign-name" x-text="signer.ketua"></p>
                            <p>Ketua Paguyuban AGV 2024-2026</p>
                        </div>
                        <div class="sign-box">
                            <p>Dibuat oleh:</p>
                            <div class="sign-gap"></div>
                            <p class="sign-name" x-text="signer.notulis_nama"></p>
                            <p x-text="signer.notulis_jabatan"></p>
                            <p>Notulis</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bottom-bar bg-white border-t border-gray-300 shadow-2xl flex justify-around items-center">
            <button @click="activeTab = 'input'" class="flex flex-col items-center p-2 text-sm transition" :class="{'text-blue-600 font-bold': activeTab === 'input', 'text-gray-500': activeTab !== 'input'}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                Input Data
            </button>
            <button @click="activeTab = 'preview'" class="flex flex-col items-center p-2 text-sm transition" :class="{'text-blue-600 font-bold': activeTab === 'preview', 'text-gray-500': activeTab !== 'preview'}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                Preview PDF
            </button>
        </div>
    </div>

    <div x-cloak x-show="showContextMenu" @click.away="showContextMenu = false" :style="`top: ${contextMenuY}px; left: ${contextMenuX}px;`" class="fixed bg-white border border-gray-300 rounded shadow-lg p-1 z-50 text-sm">
        <div class="py-1 px-3 text-xs font-bold text-gray-500 border-b mb-1">Format Teks</div>
        <button @click="applyFormat('**'); showContextMenu = false;" class="block w-full text-left px-3 py-1 hover:bg-gray-100 font-bold">Tebal (**)</button>
        <button @click="applyFormat('*'); showContextMenu = false;" class="block w-full text-left px-3 py-1 hover:bg-gray-100 italic">Miring (*)</button>
        <button @click="applyFormat('__'); showContextMenu = false;" class="block w-full text-left px-3 py-1 hover:bg-gray-100 underline">Garis Bawah (__)</button>
        <button @click="applyFormat('=='); showContextMenu = false;" class="block w-full text-left px-3 py-1 hover:bg-yellow-50 bg-yellow-100/50">Highlight (==)</button>
    </div>

    <script>
        function appData() {
            return {
                activeTab: window.innerWidth < 1024 ? 'input' : 'input', 
                zoomLevel: 1.0, 
                A4_WIDTH_PX: 794, 
                isResizing: false,
                startWidth: 380, 
                startX: 0, 
                showContextMenu: false,
                contextMenuX: 0,
                contextMenuY: 0,
                activeTextarea: null, 
                longPressTimer: null,
                popOutWindow: null, // Window reference for popout

                doc: { no: 'F-AGV-01', tgl: '25 Februari 2024', rev: '00' },
                meet: { date: new Date().toISOString().split('T')[0], time: '20.00-22.00', place: 'Bagus (C02)', agenda: 'Ngopling (Ngopi Keliling)' },
                items: [{ topic: 'Pemasangan lampu penerangan', detail: 'Detail Pekerjaan:\nKebutuhan lampu: 4 titik\nLokasi: Depan Mas Tommy, Zulfy, Andy, P. Sapto\n\nPenting: Segera dilaksanakan.', pic: 'Hanif', due: new Date().toISOString().split('T')[0] }],
                attendees: [{ name: 'Hendra', address: 'C01' }],
                photos: [],
                signer: { ketua: 'Imam Abu Hanifah', notulis_nama: 'Budi', notulis_jabatan: 'Sekretaris' },

                // --- POP OUT LOGIC ---
                popOutPreview() {
                    const width = 850;
                    const height = 1000;
                    const left = (window.screen.width / 2) - (width / 2);
                    const top = (window.screen.height / 2) - (height / 2);
                    
                    this.popOutWindow = window.open('', 'NotulenAGVPreview', `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`);
                    
                    // HTML Content for the new window
                    const content = `
                        <html>
                        <head>
                            <title>Preview Standalone - Notulen AGV</title>
                            <script src="https://cdn.tailwindcss.com"><\/script>
                            <style>
                                ${document.querySelector('style').innerHTML}
                                body { background-color: #374151; display: flex; justify-content: center; padding: 20px; overflow-y: auto; height: auto; }
                                .a4-page { margin-bottom: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
                                #pdf-content { transform: none !important; }
                            </style>
                        </head>
                        <body>
                            <div id="pdf-content">
                                ${document.getElementById('pdf-content').innerHTML}
                            </div>
                            <script>
                                window.addEventListener('message', function(event) {
                                    if (event.data.type === 'UPDATE_CONTENT') {
                                        document.getElementById('pdf-content').innerHTML = event.data.html;
                                    }
                                });
                            <\/script>
                        </body>
                        </html>
                    `;
                    
                    this.popOutWindow.document.write(content);
                    this.popOutWindow.document.close();
                },

                syncPopOut() {
                    if (this.popOutWindow && !this.popOutWindow.closed) {
                        const html = document.getElementById('pdf-content').innerHTML;
                        this.popOutWindow.postMessage({ type: 'UPDATE_CONTENT', html: html }, '*');
                    }
                },

                autoExpand(element) {
                    if (element) {
                        element.style.height = 'auto'; 
                        element.style.height = element.scrollHeight + 'px';
                    }
                },

                showCustomContextMenu(event) {
                    this.contextMenuX = event.clientX;
                    this.contextMenuY = event.clientY;
                    this.activeTextarea = event.target;
                    this.showContextMenu = true;
                },

                startLongPress(event) {
                    if (!event.touches || event.touches.length !== 1) return;
                    clearTimeout(this.longPressTimer);
                    this.activeTextarea = event.target;
                    this.longPressTimer = setTimeout(() => {
                        event.preventDefault(); 
                        this.contextMenuX = event.touches[0].clientX;
                        this.contextMenuY = event.touches[0].clientY;
                        this.showContextMenu = true;
                    }, 700);
                },

                cancelLongPress() { clearTimeout(this.longPressTimer); },

                applyFormat(syntax) {
                    if (!this.activeTextarea) return;
                    const textarea = this.activeTextarea;
                    const start = textarea.selectionStart;
                    const end = textarea.selectionEnd;
                    const marker = syntax;
                    const currentValue = textarea.value;
                    const formattedText = marker + currentValue.substring(start, end) + marker;
                    textarea.value = currentValue.substring(0, start) + formattedText + currentValue.substring(end);
                    textarea.dispatchEvent(new Event('input')); 
                    this.autoExpand(textarea); 
                },

                handleKeydown(event, index) {
                    if (!(event.ctrlKey || event.metaKey)) return; 
                    let syntax = null;
                    if (event.key.toLowerCase() === 'b') syntax = '**';
                    else if (event.key.toLowerCase() === 'i') syntax = '*';
                    else if (event.key.toLowerCase() === 'u') syntax = '__';
                    else if (event.key.toLowerCase() === 'h') syntax = '==';
                    
                    if (syntax) {
                        event.preventDefault(); 
                        this.activeTextarea = event.target;
                        this.applyFormat(syntax); 
                    }
                },

                renderMarkdown(text) {
                    if (!text) return '';
                    return text.replace(/\*\*(.*?)\*\*/gs, '<b>$1</b>')
                               .replace(/\*(.*?)\*/gs, '<i>$1</i>')
                               .replace(/__(.*?)__/gs, '<u>$1</u>')
                               .replace(/==(.*?)\=\=/gs, '<span style="background-color: #fff3c4; padding: 1px 0;">$1</span>')
                               .replace(/\n/g, '<br>');
                },

                fitToScreen() {
                    this.$nextTick(() => {
                        const containerWidth = this.$refs.previewContainer.clientWidth;
                        // Penyesuaian margin agar lebih besar di layar HP
                        const margin = window.innerWidth < 1024 ? 12 : 32;
                        this.zoomLevel = Math.max(0.3, (containerWidth - margin) / this.A4_WIDTH_PX);
                    });
                },

                formatDate(date) {
                    if (!date) return '';
                    const p = date.split('-');
                    return p.length === 3 ? `${p[2]}/${p[1]}/${p[0]}` : date;
                },

                async handlePhotos(e) {
                    const files = e.target.files;
                    for(let i=0; i<files.length; i++){
                        const reader = new FileReader();
                        reader.onload = (ev) => { this.photos.push(ev.target.result); this.saveDraft(); };
                        reader.readAsDataURL(files[i]);
                    }
                },

                saveDraft() {
                    const data = { doc: this.doc, meet: this.meet, items: this.items, attendees: this.attendees, signer: this.signer, photos: this.photos };
                    localStorage.setItem('agv_v3_draft', JSON.stringify(data));
                    // Update Popout if open
                    this.$nextTick(() => this.syncPopOut());
                },
                
                initData() {
                    const saved = localStorage.getItem('agv_v3_draft');
                    if(saved) {
                        const p = JSON.parse(saved);
                        Object.assign(this, p);
                    }
                    window.addEventListener('mousemove', (e) => this.onResize(e));
                    window.addEventListener('mouseup', () => this.stopResize());
                    this.$nextTick(() => {
                        this.fitToScreen();
                        this.$el.querySelectorAll('.sidebar-input textarea').forEach(this.autoExpand);
                    });

                    // Watchers
                    ['doc', 'meet', 'items', 'attendees', 'signer', 'photos'].forEach(key => {
                        this.$watch(key, () => this.saveDraft(), { deep: true });
                    });

                    // Update zoom otomatis saat pindah tab di mobile
                    this.$watch('activeTab', (val) => {
                        if (val === 'preview') {
                            setTimeout(() => this.fitToScreen(), 50);
                        }
                    });
                },

                addItem() { this.items.push({ topic: '', detail: '', pic: '', due: new Date().toISOString().split('T')[0] }); },
                removeItem(i) { this.items.splice(i, 1); },
                addAttendee() { this.attendees.push({ name: '', address: '' }); },
                removeAttendee(i) { this.attendees.splice(i, 1); },
                removePhoto(i) { this.photos.splice(i, 1); },

                startResize(e) { this.isResizing = true; this.startX = e.clientX; this.startWidth = this.$refs.sidebar.offsetWidth; },
                stopResize() { if (this.isResizing) { this.isResizing = false; this.fitToScreen(); } },
                onResize(e) {
                    if (!this.isResizing) return;
                    let nw = this.startWidth + (e.clientX - this.startX);
                    if (nw > 250 && nw < window.innerWidth * 0.6) {
                        document.documentElement.style.setProperty('--sidebar-width', `${nw}px`);
                        this.startWidth = nw;
                    }
                },

                handleResize() {
                    this.fitToScreen();
                },

                exportData() {
                    const blob = new Blob([JSON.stringify(this.$data)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = `Notulen_AGV_${this.meet.date}.json`; a.click();
                },

                importData(e) {
                    const reader = new FileReader();
                    reader.onload = (ev) => { Object.assign(this, JSON.parse(ev.target.result)); this.saveDraft(); };
                    reader.readAsText(e.target.files[0]);
                },

                generatePDF() { window.print(); }
            }
        }
    </script>
</body>
</html>
